# Discord 表格功能測試指南

## 🧪 測試價格異動和持倉異動表格

### 修復內容

原本的 `--test` 參數只測試了 API 連接，**沒有實際發送表格到 Discord**。現已修復為完整測試：

### 📊 新的測試功能

執行 `npm run test-discord` 或 `node src/index.js --test` 現在會：

1. **收集真實數據**：
   - ✅ 抓取實際持倉量數據 (508+ 個合約)
   - ✅ 收集真實價格數據 (多個交易對)
   - ✅ 建立多時間周期數據結構

2. **模擬歷史數據**：
   - ✅ 生成 5分/15分/1h/4h 歷史數據
   - ✅ 計算真實的變化百分比
   - ✅ 模擬正負異動數據

3. **實際發送表格到 Discord**：
   - 📊 **持倉異動表格** (正異動 + 負異動各8個)
   - 💰 **價格異動表格** (正異動 + 負異動各8個)
   - 📋 **測試報告** (詳細統計)

### 📋 表格格式驗證

**持倉異動表格**：
```
📊 持倉異動排行 正異動 TOP8 (各時間周期對比)

排名 | 幣種          | 價格異動  | 5分持倉  | 15分持倉 | 1h持倉   | 4h持倉
-----|-------------|----------|----------|----------|----------|----------
 1   | BTCUSDT     | +2.45%   | +15.30%  | +12.80%  | +8.90%   | +5.20%
 2   | ETHUSDT     | -1.20%   | +11.70%  | +9.45%   | +6.30%   | +3.80%
...
```

**價格異動表格**：
```
💰 價格異動排行 正異動 TOP8 (各時間周期對比)

排名 | 幣種          | 持倉異動  | 5分價格  | 15分價格 | 1h價格   | 4h價格
-----|-------------|----------|----------|----------|----------|----------
 1   | ADAUSDT     | +8.50%   | +3.20%   | +5.80%   | +4.10%   | +2.90%
 2   | SOLUSDT     | -2.30%   | +2.85%   | +4.60%   | +3.70%   | +1.50%
...
```

### 🔧 測試步驟

1. **設置環境變數**（必要）：
   ```bash
   export DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/your_webhook"
   # 或建立 .env 檔案參考 .env.example
   ```

2. **執行測試**：
   ```bash
   npm run test-discord
   # 或
   node src/index.js --test
   ```

3. **檢查 Discord 頻道**：
   - 📊 持倉異動正異動表格
   - 📊 持倉異動負異動表格  
   - 💰 價格異動正異動表格
   - 💰 價格異動負異動表格
   - 📋 詳細測試報告

### 📈 測試結果示例

```
📧 執行系統測試...
🔍 正在測試實際的價格異動和持倉異動表格功能...
🔗 測試合約監控器初始化...
📊 測試持倉量數據收集...
📈 測試價格數據收集...
🔍 測試多時間周期數據分析...
📋 測試表格生成功能...
✅ 成功分析 20 個交易對的數據
📊 測試持倉異動表格發送到 Discord...
✅ 持倉異動表格發送完成
💰 測試價格異動表格發送到 Discord...
✅ 價格異動表格發送完成
✅ 測試報告發送到 Discord 完成

📊 測試結果摘要:
- 持倉量數據收集: 508 個合約
- 價格數據收集: 50 個合約
- 持倉異動分析: 20 個有變化
- 價格異動分析: 20 個有變化
- 表格生成功能: 正常
- 多時間周期支持: 5分/15分/1h/4h 完整
- API 連接: 正常
```

### ⚠️ 注意事項

1. **需要 Discord Webhook**：測試會實際發送消息到 Discord
2. **真實 API 調用**：會消耗 Bitget API 額度
3. **表格數量**：總共發送 4-5 個表格到 Discord
4. **發送間隔**：表格間有 2-3 秒間隔避免頻率限制

### 🚀 正式部署

修改已推送到 GitHub，Digital Ocean 會自動部署。部署後系統會按照正確頻率發送：

- **每 5 分鐘**：持倉異動 + 價格異動表格
- **每小時 50/55/59 分**：資金費率表格

### 🔗 相關文件

- 主要實現：`src/services/bitgetContractMonitor.js`
- 測試功能：`src/index.js` (sendTestMessage 方法)
- 環境變數：`.env.example`
- 部署配置：`.do/app.yaml`