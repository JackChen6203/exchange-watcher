# Bitget 合約持倉量監控系統

根據 CLAUDE.md 要求重構的合約監控系統，專注於監控持倉量異動和資金費率排行。

## 功能特性

### 1. 持倉量監控
- **多時間週期**: 監控 15分鐘、1小時、4小時、24小時的持倉量變化
- **異動排行**: 自動生成正異動和負異動的 TOP 15 排行榜
- **實時數據**: 每5分鐘更新一次持倉量數據

### 2. 資金費率監控
- **費率排行**: 監控正資金費率和負資金費率的 TOP 15
- **異常提醒**: 當資金費率超過設定閾值時發送提醒
- **實時更新**: 定期獲取最新的資金費率數據

### 3. 自動化報告
- **定時發送**: 每15分鐘自動發送持倉異動和資金費率報告到Discord
- **詳細統計**: 包含變化金額、變化百分比等詳細信息
- **視覺化展示**: 使用Discord Embed格式，清晰展示數據

### 4. 日誌系統
- **控制台輸出**: 重要信息顯示在控制台
- **文件日誌**: 所有日誌自動保存到文件中
- **分級記錄**: 支持 debug、info、warn、error 四個級別

## 安裝和配置

### 1. 環境要求
- Node.js 16.0 或更高版本
- npm 或 yarn 包管理器

### 2. 安裝依賴
```bash
npm install
```

### 3. 環境變量配置
創建 `.env` 文件並設置以下變量：

```env
# Bitget API 憑證
API_KEY=your_api_key
API_SECRET=your_api_secret
API_PASSPHRASE=your_passphrase

# Discord Webhook URL
DISCORD_WEBHOOK_URL=your_discord_webhook_url

# 可選配置
LOG_LEVEL=info
VERBOSE_LOGGING=false
PRICE_CHANGE_THRESHOLD=10
POSITION_CHANGE_THRESHOLD=10
FUNDING_RATE_HIGH_THRESHOLD=0.1
FUNDING_RATE_LOW_THRESHOLD=-0.1
```

### 4. 啟動系統

#### 正常模式
```bash
npm start
```

#### 開發模式（帶自動重啟）
```bash
npm run dev
```

#### 測試模式
```bash
node test/bitgetContractTest.js
```

#### Discord 測試
```bash
node src/index.js --test
```

## 系統架構

### 主要模塊

1. **BitgetContractMonitor** (`src/services/bitgetContractMonitor.js`)
   - 合約監控的核心邏輯
   - 數據收集、處理和排行計算
   - 定時報告生成

2. **BitgetApi** (`src/services/bitgetApi.js`)
   - Bitget API 封裝
   - 開倉量和資金費率數據獲取
   - API 錯誤處理和重試機制

3. **DiscordService** (`src/services/discordService.js`)
   - Discord 消息發送
   - Embed 格式化
   - 錯誤報告

4. **Logger** (`src/utils/logger.js`)
   - 日誌記錄和輸出控制
   - 文件和控制台雙重輸出
   - 重要信息過濾

### 數據流程

1. **初始化階段**
   - 獲取所有 USDT 永續合約
   - 收集初始持倉量和資金費率數據
   - 設置定時任務

2. **監控階段**
   - 每5分鐘更新合約數據
   - 維護多個時間週期的歷史數據
   - 實時計算變化量和排行

3. **報告階段**
   - 每15分鐘生成綜合報告
   - 發送持倉異動排行（4個時間週期）
   - 發送資金費率排行（正負各TOP15）

## 監控數據說明

### 持倉量排行

#### 正異動排行
- 顯示持倉量增長最多的合約
- 包含變化金額和變化百分比
- 分別展示 15分鐘、1小時、4小時、24小時的數據

#### 負異動排行
- 顯示持倉量減少最多的合約
- 有助於識別市場趨勢變化
- 可能指示大量平倉或反向操作

### 資金費率排行

#### 正資金費率（多頭付費）
- 表示多頭情緒強烈
- 數值越高，多頭付費越多
- 可能預示價格調整風險

#### 負資金費率（空頭付費）
- 表示空頭情緒強烈
- 數值越低，空頭付費越多
- 可能預示反彈機會

## 故障排除

### 常見問題

1. **API 連接失敗**
   - 檢查 API 憑證是否正確
   - 確認網絡連接正常
   - 查看 Bitget API 狀態

2. **Discord 消息發送失敗**
   - 檢查 Webhook URL 是否有效
   - 確認 Discord 服務器設置
   - 查看錯誤日誌詳情

3. **數據獲取異常**
   - 檢查 API 權限設置
   - 確認合約交易對狀態
   - 查看 API 調用頻率限制

### 日誌查看

系統日誌保存在 `logs/monitor.log` 文件中，包含：
- 系統啟動和關閉記錄
- API 調用結果
- 數據處理過程
- 錯誤和警告信息

### 性能監控

系統會定期輸出運行狀態，包括：
- 運行狀態（運行中/已停止）
- 監控的合約數量
- 持倉數據和資金費率數據量
- 系統資源使用情況

## 技術特點

1. **高可靠性**
   - 完整的錯誤處理機制
   - 自動重試和恢復
   - 優雅關閉支持

2. **高性能**
   - 批量 API 調用
   - 內存數據緩存
   - 異步並發處理

3. **易維護**
   - 模塊化設計
   - 詳細的日誌記錄
   - 清晰的配置管理

4. **可擴展**
   - 支持多時間週期
   - 靈活的閾值配置
   - 可定制的報告格式

## 注意事項

1. **API 限制**
   - 注意 Bitget API 的調用頻率限制
   - 合理設置監控間隔
   - 避免同時運行多個實例

2. **資源使用**
   - 系統會消耗一定的內存存儲歷史數據
   - 長時間運行建議定期重啟
   - 監控日誌文件大小

3. **數據準確性**
   - 持倉量數據可能有延遲
   - 資金費率按交易所實際結算
   - 建議結合其他數據源驗證

## 更新日誌

### v2.0.0 (當前版本)
- 完全重構為合約監控系統
- 新增多時間週期持倉量監控
- 新增資金費率排行功能
- 優化日誌輸出和文件記錄
- 改進錯誤處理和穩定性

### v1.0.0
- 基礎現貨價格監控功能
- Discord 消息推送
- 基本的 WebSocket 連接