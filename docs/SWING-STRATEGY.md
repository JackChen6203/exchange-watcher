# 波段策略 (Swing Strategy)

## 功能概述

波段策略是一個基於技術分析的交易信號檢測系統，專門用於識別加密貨幣市場中的中短期趨勢反轉機會。該策略結合了移動平均線分析、趨勢判斷和反轉形態識別，為交易者提供高質量的進場信號。

## 核心監控條件

### 1. 均線不糾纏條件
- **檢查範圍**: 60根K棒內（例如：50分級別則在900分鐘內）
- **糾纏定義**: 三條EMA（12、30、55）互相碰觸
- **條件要求**: 在指定範圍內，三條EMA必須保持不糾纏狀態
- **糾纏閾值**: 0.3%（當EMA之間的距離小於此閾值時視為糾纏）

### 2. 趨勢排列確認
- **多頭排列**: EMA12 > EMA30 > EMA55
- **空頭排列**: EMA12 < EMA30 < EMA55
- **要求**: 必須有明確的趨勢排列才能進入監控狀態

### 3. K棒未觸碰EMA55
- **檢查範圍**: 60根K棒內
- **條件要求**: 在指定範圍內，所有K棒的高低點都不能觸碰到EMA55
- **目的**: 確保趨勢的純淨性，避免在震盪區間產生信號

### 4. 回踩EMA30
- **檢查範圍**: 最近5根K線
- **多頭條件**: 價格從上方回踩EMA30（K線低點≤EMA30且高點≥EMA30）
- **空頭條件**: 價格從下方反彈EMA30（K線低點≤EMA30且高點≥EMA30）

### 5. 反轉形態確認
- **多頭信號**: 陽包陰形態（前一根陰線被當前陽線完全包含）
- **空頭信號**: 陰包陽形態（前一根陽線被當前陰線完全包含）
- **包含條件**: 當前K線的開盤價和收盤價完全包含前一根K線的開盤價和收盤價

## 信號觸發邏輯

### 策略狀態管理
1. **初始狀態**: `waiting` - 等待滿足基本條件
2. **監控狀態**: `monitoring` - 滿足不糾纏和趨勢條件，等待回踩
3. **觸發狀態**: `triggered` - 檢測到回踩，等待反轉形態
4. **冷卻狀態**: `cooldown` - 發送信號後的冷卻期

### 完整觸發流程
1. **趨勢確認**: 檢查EMA排列是否形成明確趨勢
2. **不糾纏檢測**: 確認60根K棒內三條EMA無糾纏
3. **EMA55檢測**: 確認60根K棒內未觸碰EMA55
4. **回踩EMA30**: 檢測到價格回踩EMA30
5. **反轉形態**: 識別陽包陰或陰包陽形態
6. **收線確認**: 等待K線收線後立即發送通知
7. **冷卻機制**: 避免重複信號（默認30分鐘冷卻期）

## 價格計算與風險管理

### 進場價格
- **下一根開盤價**: 使用當前K線收盤價作為下一根K棒的預期開盤價

### 止損設置
- **多頭止損**: 開盤價 × 0.985（-1.5%）
- **空頭止損**: 開盤價 × 1.015（+1.5%）

### 止盈設置
- **多頭止盈**: 開盤價 × 1.0225（+2.25%）
- **空頭止盈**: 開盤價 × 0.9775（-2.25%）

### 風險回報比
- **固定比例**: 1:1.5
- **風險**: 1.5%
- **回報**: 2.25%

## 通知格式

### Discord通知內容
- 交易對（Symbol）
- 時間週期（Timeframe）
- 策略方向（多頭/空頭）
- 反轉形態（陽包陰/陰包陽）
- 下一根開盤價
- 止損價位
- 止盈價位
- 風險回報比
- 時間戳記

## 配置說明

### 核心參數
```javascript
{
  minNoEntanglementBars: 60,        // 不糾纏檢查範圍（K棒數量）
  entanglementThreshold: 0.003,     // 糾纏閾值（0.3%）
  cooldownPeriod: 30 * 60 * 1000,   // 冷卻期（30分鐘）
  emaPeriods: [12, 30, 55],         // EMA週期
  timeframes: ['15m', '30m', '1h']  // 監控時間週期
}
```

### 監控週期
- **15分鐘**: 短期波段機會
- **30分鐘**: 中期波段機會
- **1小時**: 長期波段機會

### 監控幣種
- **篩選標準**: 24小時成交量前50名的USDT永續合約
- **自動更新**: 每次啟動時重新載入交易對列表
- **排除條件**: 成交量過低或流動性不足的交易對

## 技術指標說明

### EMA（指數移動平均線）
- **EMA12**: 短期趨勢指標，反應價格變化最敏感
- **EMA30**: 中期趨勢指標，用於回踩確認
- **EMA55**: 長期趨勢指標，用於趨勢過濾

### 糾纏檢測算法
```javascript
// 計算EMA之間的距離百分比
const distance = Math.abs(ema1 - ema2) / Math.max(ema1, ema2);
const isEntangled = distance < entanglementThreshold;
```

### 反轉形態檢測
```javascript
// 陽包陰（多頭）
const isBullishEngulfing = 
  prevClose < prevOpen &&           // 前一根是陰線
  currentClose > currentOpen &&     // 當前是陽線
  currentOpen <= prevClose &&       // 包含關係
  currentClose >= prevOpen;

// 陰包陽（空頭）
const isBearishEngulfing = 
  prevClose > prevOpen &&           // 前一根是陽線
  currentClose < currentOpen &&     // 當前是陰線
  currentOpen >= prevClose &&       // 包含關係
  currentClose <= prevOpen;
```

## 測試命令

```bash
# 運行波段策略測試
npm run test:swing

# 啟動波段策略監控
npm run start

# 啟動增強版監控（包含波段策略）
npm run start:enhanced
```

## 系統架構

### 核心類別
- **SwingStrategyService**: 主要策略邏輯類別
- **BitgetService**: Bitget API 整合
- **DiscordService**: Discord 通知服務

### 關鍵方法
- `checkNewStrategySignal()`: 主要信號檢測邏輯
- `checkEntanglementInRange()`: 糾纏檢測（60根K棒範圍）
- `checkTouchEMA55InRange()`: EMA55觸碰檢測
- `checkTouchEMA30()`: EMA30回踩檢測
- `checkReversalPattern()`: 反轉形態檢測
- `isKlineClosed()`: K線收線判斷

### 狀態管理
- 每個交易對和時間週期組合都有獨立的策略狀態
- 使用Map結構儲存策略狀態和冷卻時間
- 支援狀態重置和參數動態調整

## 注意事項

1. **市場條件**: 策略在趨勢明確的市場中表現最佳
2. **風險控制**: 嚴格執行止損，避免大幅虧損
3. **資金管理**: 建議單筆交易風險不超過總資金的2%
4. **回測驗證**: 建議在實盤使用前進行充分的歷史回測
5. **監控頻率**: 避免過度頻繁的檢查，以免產生過多信號
6. **網路穩定**: 確保網路連接穩定，避免錯過重要信號
7. **API限制**: 注意交易所API調用頻率限制

## 更新日誌

### v2.0.0 (最新)
- 修正進場條件：將20根K棒不糾纏改為60根K棒內三條EMA無糾纏檢測
- 新增檢查K棒未觸碰到EMA55的條件邏輯
- 保持回測EMA30後出現陰包陽/陽包陰形態並收線確認的邏輯
- 優化糾纏檢測算法，提高信號準確性
- 完善文檔說明和測試覆蓋率