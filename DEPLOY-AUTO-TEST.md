# Digital Ocean 部署自動測試

## 🚀 自動測試功能

現在當應用程式在 Digital Ocean App Platform 上部署完成後，會自動執行測試來驗證功能。

### 📋 自動執行流程

1. **應用程式啟動** → 健康檢查伺服器啟動
2. **監控系統初始化** → 合約監控器啟動
3. **發送啟動消息** → Discord 通知系統已啟動
4. **自動測試執行**（10秒後）→ 完整功能測試

### 🧪 測試內容

部署完成後自動執行的測試包括：

1. **持倉量數據收集測試**：
   - ✅ 抓取 500+ 個合約的實際持倉量數據
   - ✅ 驗證 API 連接和數據格式

2. **價格數據收集測試**：
   - ✅ 收集多個交易對的實際價格數據
   - ✅ 建立多時間周期數據結構

3. **表格功能測試**：
   - 📊 **持倉異動表格**（正負異動各8個）
   - 💰 **價格異動表格**（正負異動各8個）
   - 📋 **詳細測試報告**

4. **Discord 發送測試**：
   - ✅ 實際發送 4-5 個表格到 Discord 頻道
   - ✅ 驗證表格格式和內容正確性

### 📊 測試時機

- **觸發條件**：`NODE_ENV=production` 且 `SKIP_DEPLOY_TEST≠true`
- **執行時間**：系統啟動後 10 秒
- **頻率**：僅在部署啟動時執行一次

### 🔧 控制選項

可以通過環境變數控制測試行為：

```yaml
# 跳過部署測試
- key: SKIP_DEPLOY_TEST
  value: "true"  # 設為 true 跳過自動測試

# 執行部署測試（預設）
- key: SKIP_DEPLOY_TEST  
  value: "false" # 或不設置，會自動執行測試
```

### 📱 Discord 通知

部署完成後，Discord 頻道會收到：

1. **系統啟動通知** → 確認系統已部署
2. **持倉異動表格** → 正異動 + 負異動各8個
3. **價格異動表格** → 正異動 + 負異動各8個  
4. **測試完成報告** → 詳細統計和狀態

### 📈 監控狀態

測試完成後，系統進入正常監控模式：

- **每 5 分鐘**：持倉異動 + 價格異動表格
- **每小時 50/55/59 分**：資金費率表格
- **健康檢查**：`/health` 端點持續運作

### 🔍 日誌監控

可以在 Digital Ocean 控制台的 "Runtime Logs" 中查看：

```
✅ 監控系統啟動成功
🧪 執行部署後自動測試...
🔗 測試合約監控器初始化...
📊 測試持倉量數據收集...
📈 測試價格數據收集...
🔍 測試多時間周期數據分析...
✅ 成功分析 XX 個交易對的數據
📊 測試持倉異動表格發送到 Discord...
✅ 持倉異動表格發送完成
💰 測試價格異動表格發送到 Discord...
✅ 價格異動表格發送完成
✅ 測試報告發送到 Discord 完成
✅ 部署後測試完成
```

### ⚠️ 注意事項

1. **需要環境變數**：確保 `DISCORD_WEBHOOK_URL` 正確設置
2. **API 額度消耗**：測試會使用 Bitget API 調用額度
3. **Discord 頻率**：會發送多個表格，注意頻道通知
4. **測試時間**：完整測試約需 30-60 秒

### 🚀 部署驗證

部署完成後，可以通過以下方式驗證：

1. **檢查日誌**：Digital Ocean 控制台 → Runtime Logs
2. **檢查 Discord**：確認收到啟動通知和測試表格
3. **健康檢查**：訪問 `https://your-app.ondigitalocean.app/health`
4. **狀態頁面**：訪問 `https://your-app.ondigitalocean.app/status`

系統部署並測試成功後，會持續按照設定的頻率發送監控報告到 Discord！