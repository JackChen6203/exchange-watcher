name: Direct Deploy to GCP VM

on:
  push:
    branches: [ main, fix-errors ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:enhanced --if-present
    
    - name: Lint code
      run: npm run lint --if-present

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix-errors'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to GCP VM
      run: |
        # å‰µå»ºè‡¨æ™‚ç›®éŒ„ä¸¦è¤‡è£½æ–‡ä»¶ï¼ˆé¿å… tar éŒ¯èª¤ï¼‰
        mkdir -p /tmp/deploy-temp
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='*.tar.gz' --exclude='.github' . /tmp/deploy-temp/
        
        # å‰µå»ºéƒ¨ç½²åŒ…
        cd /tmp/deploy-temp
        tar -czf ../app.tar.gz .
        cd -
        
        # è¤‡è£½åˆ°æœå‹™å™¨
        scp /tmp/deploy-temp/../app.tar.gz ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:~/
        scp deploy/direct-deploy.sh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:~/
        scp deploy/server-fix.sh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:~/
        
        # æ¸…ç†è‡¨æ™‚æ–‡ä»¶
        rm -rf /tmp/deploy-temp /tmp/app.tar.gz
        
        # åŸ·è¡Œéƒ¨ç½²
        ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} << 'EOF'
          # è§£å£“ç¸®æ‡‰ç”¨ç¨‹å¼
          rm -rf ~/app-temp
          mkdir ~/app-temp
          cd ~/app-temp
          tar -xzf ~/app.tar.gz
          
          # åŸ·è¡Œéƒ¨ç½²è…³æœ¬
          chmod +x ~/direct-deploy.sh
          ~/direct-deploy.sh
          
          # åŸ·è¡Œä¼ºæœå™¨ä¿®å¾©è…³æœ¬
          chmod +x ~/server-fix.sh
          ~/server-fix.sh
          
          # æ¸…ç†
          cd ~
          rm -rf ~/app-temp ~/app.tar.gz ~/direct-deploy.sh ~/server-fix.sh
        EOF
    
    - name: Health Check
      run: |
        sleep 30
        ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} << 'EOF'
          # æª¢æŸ¥ systemd æœå‹™ç‹€æ…‹
          if sudo systemctl is-active --quiet crypto-monitor; then
            echo "âœ… æ‡‰ç”¨ç¨‹å¼é‹è¡Œæ­£å¸¸"
            sudo systemctl status crypto-monitor --no-pager -l
            echo "--- æœ€è¿‘æ—¥èªŒ ---"
            sudo journalctl -u crypto-monitor -n 20 --no-pager
          else
            echo "âŒ æ‡‰ç”¨ç¨‹å¼é‹è¡Œç•°å¸¸"
            sudo systemctl status crypto-monitor --no-pager -l
            sudo journalctl -u crypto-monitor -n 50 --no-pager
            exit 1
          fi
        EOF
    
    - name: Show Management Commands
      if: success()
      run: |
        echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
        echo "ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}"
        echo "sudo systemctl status crypto-monitor    # æŸ¥çœ‹æœå‹™ç‹€æ…‹"
        echo "sudo journalctl -u crypto-monitor -f    # æŸ¥çœ‹å³æ™‚æ—¥èªŒ"
        echo "sudo systemctl restart crypto-monitor   # é‡å•Ÿæœå‹™"
        echo "sudo systemctl stop crypto-monitor      # åœæ­¢æœå‹™"
        echo "sudo systemctl start crypto-monitor     # å•Ÿå‹•æœå‹™"
        echo ""
        echo "ğŸ“ é‡è¦è·¯å¾‘ï¼š"
        echo "/home/${{ secrets.GCP_USER }}/crypto-exchange-monitor/.env  # é…ç½®æª”æ¡ˆ"
        echo "/home/${{ secrets.GCP_USER }}/logs/                        # æ—¥èªŒç›®éŒ„"
        echo "/home/${{ secrets.GCP_USER }}/data/                        # æ•¸æ“šç›®éŒ„"
    
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ ç›´æ¥éƒ¨ç½²å¤±æ•—ï¼"
        echo "è«‹æª¢æŸ¥ä¸Šæ–¹æ—¥èªŒæˆ– SSH åˆ°æœå‹™å™¨æ‰‹å‹•æª¢æŸ¥ï¼š"
        echo "ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}"